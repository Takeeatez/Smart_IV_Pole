# 센서 드리프트 자동 보정 알고리즘 추가 완료

## 변경 사항

[sketch_sep12a.ino](sketch_sep12a/sketch_sep12a.ino#L826-L847)에 **크립 자동 보정 알고리즘** 추가

### 알고리즘 동작 원리

1. **감지 조건**: 유속 < 0.3 mL/분 AND 60초 데이터 확보됨
   - 유속이 거의 0에 가까우면 → 수액이 떨어지지 않거나 막힌 상태
   - 이 상태에서 무게가 줄어든다면 → 센서 드리프트로 판단

2. **보정 로직**:
   - 최근 60초간 무게의 평균값 계산
   - 초기 무게와 평균값의 차이(드리프트) 계산
   - 드리프트가 2g 이상이면 → 자동 보정 실행

3. **보정 실행**:
   ```
   초기 무게 = 60초 평균 무게
   ```
   - 이후 잔여량, 퍼센트, 예상 시간이 보정된 값으로 재계산됨

### 시리얼 모니터 출력 예시

**드리프트 감지 시**:
```
[120s] 무게: 1112.5g (잔량: 498.2g, 99.6%) | 유속: 0.15 mL/분 (처방: 2.78, 편차: -94.6%) [60s] | 예상완료: 3321분 후

⚙️ 센서 드리프트 감지 및 보정: 1118.7g → 1112.5g (드리프트: -6.2g)

[121s] 무게: 1112.3g (잔량: 498.0g, 100.0%) | 유속: 0.18 mL/분 (처방: 2.78, 편차: -93.5%) [60s] | 예상완료: 2766분 후
```

**정상 측정 시** (드리프트 없음):
```
[60s] 무게: 497.2g (잔량: 497.2g, 99.4%) | 유속: 2.80 mL/분 (처방: 2.78, 편차: +0.7%) [60s] | 예상완료: 177분 후
[61s] 무게: 496.8g (잔량: 496.8g, 99.3%) | 유속: 2.78 mL/분 (처방: 2.78, 편차: 0.0%) [60s] | 예상완료: 178분 후
```

## 알고리즘 특징

### 장점
1. ✅ **자동 보정**: 수동 개입 없이 드리프트 자동 감지 및 보정
2. ✅ **안전한 조건**: 유속이 낮을 때만 작동 (정상 측정 방해하지 않음)
3. ✅ **임계값 설정**: 2g 이상 드리프트만 보정 (노이즈 무시)
4. ✅ **투명성**: 보정 실행 시 시리얼 모니터에 명확히 표시

### 제한사항
1. ⚠️ 60초 데이터 필요 → 초기 60초간은 보정 불가
2. ⚠️ 유속 < 0.3 mL/분 조건 → 정상 투여 중에는 작동 안 함
3. ⚠️ 2g 임계값 → 매우 미세한 드리프트(<2g)는 보정 안 됨

## 테스트 방법

### 테스트 1: 드리프트 자동 보정 확인
1. Arduino IDE에서 업데이트된 코드 업로드
2. 시리얼 모니터 실행 (115200 baud)
3. 't' 명령으로 영점 조정
4. 수액 걸기
5. 'w' 명령으로 초기 무게 측정 (5초 대기 후)
6. **수액 잠금** (방울이 떨어지지 않게)
7. 60초 이상 대기
8. 시리얼 모니터에서 드리프트 보정 메시지 확인

**예상 결과**:
- 유속: ~0 mL/분으로 측정됨
- 드리프트가 2g 이상이면 자동 보정 메시지 출력
- 잔여량 퍼센트가 100%로 재조정됨

### 테스트 2: 정상 투여 시 미작동 확인
1. 't' → 'w' 명령으로 초기 설정
2. **수액 정상 투여** (방울 떨어짐)
3. 60초 이상 대기
4. 드리프트 보정 메시지가 **나오지 않음** 확인

**예상 결과**:
- 유속: 처방값 근처 (예: 2.78 mL/분)
- 드리프트 보정 **실행 안 됨** (유속 > 0.3 mL/분)
- 정상 측정 계속 진행

### 테스트 3: 센서 안정성 진단
```
'd' 명령 실행 → 10초간 무게 변화 관찰
```

**판단 기준** (SENSOR_DRIFT_DIAGNOSIS.md 참고):
- 변화량 < ±0.2g/초 → 정상 (소프트웨어 보정 충분)
- 변화량 0.2-0.5g/초 → 경미한 드리프트 (현재 알고리즘으로 대응 가능)
- 변화량 > 0.5g/초 → 하드웨어 문제 (전원/온도 점검 필요)

## 다음 단계

1. **코드 업로드**: Arduino IDE에서 sketch_sep12a.ino 업로드
2. **테스트 1 실행**: 드리프트 자동 보정 동작 확인
3. **'d' 명령 실행**: 센서 안정성 진단 결과 공유
4. **결과에 따른 추가 조치**:
   - 드리프트 < 0.5g/초 → 현재 보정 알고리즘으로 충분
   - 드리프트 0.5-1g/초 → 하드웨어 개선 권장 (전원 안정화)
   - 드리프트 > 1g/초 → 하드웨어 교체 필요

## 추가 개선 가능 사항 (선택)

### 1. 임계값 조정
현재 2g → 상황에 따라 조정 가능
```cpp
if (drift > 2.0) {  // 이 값을 변경
```

### 2. 유속 조건 변경
현재 0.3 mL/분 → 더 높은 값으로 변경 시 더 자주 보정
```cpp
if (flowRate >= 0 && flowRate < 0.3 && weight60Full) {  // 0.3을 변경
```

### 3. 주기적 보정
매 5분마다 자동 보정 (드리프트 누적 방지):
```cpp
unsigned long lastCreepCorrection = 0;
const unsigned long CREEP_CORRECTION_INTERVAL = 300000;  // 5분

// STABLE 상태에서:
if (now - lastCreepCorrection >= CREEP_CORRECTION_INTERVAL && weight60Full) {
  // 크립 보정 로직 실행
  lastCreepCorrection = now;
}
```

## 참고 문서
- [SENSOR_DRIFT_DIAGNOSIS.md](SENSOR_DRIFT_DIAGNOSIS.md) - 센서 드리프트 진단 가이드
- [ESP8266_TEST_GUIDE.md](ESP8266_TEST_GUIDE.md) - ESP8266 테스트 절차

## 문제 발생 시
1. 시리얼 모니터 전체 출력 캡처
2. 'd' 명령 실행 결과 공유
3. 's' 명령으로 현재 상태 확인
4. 드리프트 보정 메시지 발생 시 전후 무게 기록
