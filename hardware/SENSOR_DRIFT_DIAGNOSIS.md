# HX711 센서 드리프트 문제 진단 가이드

## 현상
- 수액이 떨어지지 않는 상태에서 무게가 계속 감소
- 초기 무게: 1118.77g → 현재 무게: 1112.89g (약 6g 감소)

## 가능한 원인 및 해결 방법

### 1. 로드셀 크립(Creep) 현상
**증상**: 일정한 하중 하에서 시간이 지남에 따라 출력이 감소
**특징**:
- 선형적으로 감소 (예: 0.5-1g/분)
- 온도 변화 없어도 발생
- 초기 10-20분간 더 심함

**해결 방법**:
1. 초기 무게 측정 전 10분 대기 (크립 안정화)
2. 크립 보정 알고리즘 추가:
```cpp
// 크립 보정: 유속이 0에 가까우면 초기 무게 재조정
if (flowRate < 0.5 && weight60Full) {
  float avgWeight = 0;
  for (int i = 0; i < 60; i++) {
    avgWeight += weightHistory60[i];
  }
  avgWeight /= 60;
  initialWeight = avgWeight;  // 초기 무게 업데이트
}
```

### 2. 온도 드리프트
**증상**: 온도 변화에 따른 센서 출력 변화
**특징**:
- 비선형적 변화
- 주변 온도 변화와 연관
- ESP8266 발열 영향

**해결 방법**:
1. HX711과 ESP8266 분리 배치 (열 차단)
2. 온도 센서 추가 (DHT22 등) 및 보정
3. 알루미늄 히트싱크 부착

### 3. 전원 불안정
**증상**: 불규칙한 센서 읽기 오류 + 드리프트
**특징**:
- 무작위 변동 + 드리프트 혼합
- WiFi 전송 중 더 심함
- 전원 노이즈 영향

**해결 방법**:
1. HX711 전원에 100μF 캐패시터 추가 (전원 안정화)
2. 별도 5V 레귤레이터 사용 (ESP8266과 분리)
3. 전원선 분리 및 트위스트

### 4. 기계적 문제
**증상**: 예측 불가능한 무게 변화
**특징**:
- 불규칙한 변동
- 진동/충격 시 변화

**해결 방법**:
1. 로드셀 고정 상태 확인 (볼트 조임)
2. 케이블 고정 (움직임 최소화)
3. 진동 차단 패드 추가

### 5. 캘리브레이션 오류
**증상**: 일정한 비율로 오차 증가
**특징**:
- 선형적 오차
- calibration_factor 부정확

**해결 방법**:
1. 정확한 분동으로 재캘리브레이션
2. 여러 무게 구간에서 테스트 (100g, 500g, 1000g)

## 진단 절차

### Step 1: 센서 안정성 테스트
```
Arduino IDE → 시리얼 모니터 실행
'd' 명령 입력 → 10초간 무게 변화 관찰
```

**판단 기준**:
- 변화량 < ±0.2g/초 → **정상** (알고리즘 문제)
- 변화량 0.2-0.5g/초 → **경미한 드리프트** (소프트웨어 보정 가능)
- 변화량 > 0.5g/초 → **하드웨어 문제** (전원/온도/기계적)

### Step 2: 크립 테스트
```
1. 't' 명령으로 영점 조정
2. 수액 걸기 (500ml 기준)
3. 10분 대기
4. 's' 명령으로 무게 확인 (5회 측정)
5. 다시 10분 대기
6. 's' 명령 재실행
```

**판단 기준**:
- 10분간 <2g 감소 → 정상 크립
- 10분간 2-5g 감소 → 중간 크립 (소프트웨어 보정 필요)
- 10분간 >5g 감소 → 높은 크립 (하드웨어 교체 고려)

### Step 3: 온도 영향 테스트
```
1. ESP8266 부팅 직후 무게 측정
2. 30분 후 다시 측정 (ESP 발열 안정화)
3. 온도 변화 관찰
```

### Step 4: 전원 안정성 테스트
```
1. 센서 연속 측정 중 WiFi 전송 실행
2. 'd' 명령 실행 중 ESP.wdtFeed() 호출
3. 무게 변동 관찰
```

## 즉각 적용 가능한 해결책

### 해결책 1: 크립 보정 알고리즘 (권장)
sketch_sep12a.ino의 STABLE 상태 로직에 추가:

```cpp
// 유속이 매우 낮으면 (흔들림) 초기 무게 재조정
if (flowRate >= 0 && flowRate < 0.3 && weight60Full) {
  float avgWeight = 0;
  for (int i = 0; i < 60; i++) {
    avgWeight += weightHistory60[i];
  }
  avgWeight /= 60;

  // 초기 무게와 평균의 차이가 2g 이상이면 보정
  if (abs(initialWeight - avgWeight) > 2.0) {
    Serial.print("⚙️ 크립 보정: ");
    Serial.print(initialWeight);
    Serial.print("g → ");
    Serial.print(avgWeight);
    Serial.println("g");
    initialWeight = avgWeight;
  }
}
```

### 해결책 2: 안정화 대기 시간 추가
't' 명령 후 즉시 측정하지 말고 안정화:

```cpp
} else if (command == 't') {
  Serial.println("영점 조정 중...");
  baselineWeight = safeReadSensor();

  Serial.println("⏳ 센서 안정화 중 (10초)...");
  for (int i = 10; i > 0; i--) {
    Serial.print(i);
    Serial.print("... ");
    delay(1000);
    ESP.wdtFeed();
  }
  Serial.println();

  // 재측정
  baselineWeight = safeReadSensor();
  Serial.print("영점 무게: ");
  Serial.print(baselineWeight);
  Serial.println(" g");
  currentState = INITIAL_WEIGHT;
}
```

### 해결책 3: 전원 안정화 (하드웨어)
1. HX711 VCC-GND 사이에 100μF 전해 캐패시터 추가
2. 0.1μF 세라믹 캐패시터 병렬 연결

## 다음 단계

1. **먼저 'd' 명령 실행 결과 공유** → 드리프트 속도 확인
2. 드리프트 속도에 따라:
   - < 0.2g/초 → 소프트웨어 보정 (해결책 1)
   - 0.2-0.5g/초 → 소프트웨어 + 하드웨어 개선 (해결책 1+3)
   - > 0.5g/초 → 하드웨어 점검 필수 (배선, 전원, 센서 교체)

## 참고 자료
- HX711 데이터시트: 일반적 크립 < 0.1% (500ml 기준 < 0.5g)
- 의료 기기 정확도 요구사항: ±2% (500ml 기준 ±10g 허용)
