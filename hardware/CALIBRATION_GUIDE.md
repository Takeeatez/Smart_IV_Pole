# 로드셀 캘리브레이션 가이드

## 📋 캘리브레이션이 필요한 이유

로드셀은 제조사, 모델, 개별 특성에 따라 출력 값이 다릅니다. 정확한 무게 측정을 위해서는 각 로드셀에 맞는 calibration_factor를 찾아야 합니다.

## 🛠️ 준비물

1. **측정 장비**
   - ESP8266 + HX711 + 로드셀 (연결 완료)
   - USB 케이블

2. **기준 무게**
   - 정확한 무게를 아는 물체 (권장: 500g, 1kg, 2kg)
   - 예: 생수병 (500ml = 약 500g), 쌀 1kg, 아령 등

3. **소프트웨어**
   - Arduino IDE 또는 PlatformIO
   - 시리얼 모니터

## 📐 캘리브레이션 방법

### 방법 1: 대화형 캘리브레이션 프로그램 사용 (권장)

1. **캘리브레이션 코드 업로드**
   ```bash
   # Arduino IDE에서
   File → Open → calibration.ino
   Upload
   ```

2. **시리얼 모니터 열기**
   - Baud rate: 115200
   - Line ending: "No line ending" 또는 "Newline"

3. **영점 조정 (Tare)**
   - 로드셀에서 모든 무게 제거
   - 시리얼 모니터에 `t` 입력
   - 3초 대기

4. **캘리브레이션 실행**
   - 시리얼 모니터에 `c` 입력
   - 안내에 따라 진행:
     - 로드셀 비우고 Enter
     - 기준 무게(1kg) 올리고 Enter
   - 자동으로 calibration_factor 계산

5. **미세 조정**
   - 표시되는 무게가 실제와 다르면:
     - `+` : factor 100 증가
     - `-` : factor 100 감소
     - `1` : factor 10 증가
     - `2` : factor 10 감소

6. **값 저장**
   - 정확한 무게가 표시되면 `s` 입력
   - 표시된 calibration_factor 값을 메모

### 방법 2: MQTT 명령을 통한 캘리브레이션

1. **메인 코드 업로드**
   ```bash
   esp8266_loadcell.ino 업로드
   ```

2. **MQTT 클라이언트 준비**
   ```bash
   # MQTT Explorer 또는 mosquitto_pub 사용
   mosquitto_pub -h 192.168.1.100 -t "pole_001/command" -m '{"command":"calibrate"}'
   ```

3. **시리얼 모니터 확인**
   - 캘리브레이션 진행 상황 확인
   - 최종 calibration_factor 값 확인

### 방법 3: 수동 계산

1. **Raw 값 측정**
   ```cpp
   // 테스트 코드
   void setup() {
     Serial.begin(115200);
     scale.begin(LOADCELL_DOUT_PIN, LOADCELL_SCK_PIN);
     scale.tare();
   }
   
   void loop() {
     Serial.println(scale.read_average(20));  // Raw 값
     delay(1000);
   }
   ```

2. **계산**
   ```
   calibration_factor = (Raw값_무게있음 - Raw값_비었을때) / 실제무게(g)
   ```

## 🎯 정확도 확인

### 테스트 절차

1. **다양한 무게로 테스트**
   ```
   - 빈 상태: 0g (±2g)
   - 500ml 물: 500g (±5g)
   - 1L 물: 1000g (±10g)
   - 2L 물: 2000g (±15g)
   ```

2. **선형성 확인**
   - 여러 무게에서 오차율 계산
   - 오차율 = (측정값 - 실제값) / 실제값 × 100%
   - 목표: ±2% 이내

3. **안정성 확인**
   - 같은 무게를 5분간 측정
   - 값의 변동 확인 (목표: ±1g)

## 📝 calibration_factor 적용

### 메인 코드 수정

```cpp
// esp8266_loadcell.ino 파일에서
float calibration_factor = -2230.0;  // 기본값

// 캘리브레이션으로 찾은 값으로 변경
float calibration_factor = -2156.7;  // 예시: 실제 측정값
```

### 일반적인 calibration_factor 범위

| 로드셀 종류 | 일반적인 범위 |
|------------|---------------|
| 1kg | -2000 ~ -2500 |
| 2kg | -1800 ~ -2200 |
| 5kg | -400 ~ -450 |
| 10kg | -200 ~ -250 |
| 20kg | -100 ~ -150 |
| 50kg | -80 ~ -120 |

⚠️ **주의**: 음수 값이 일반적이지만, 배선에 따라 양수일 수도 있습니다.

## 🔧 문제 해결

### 문제: 값이 불안정함
**해결책:**
- 로드셀 고정 상태 확인
- 전원 안정성 확인 (3.3V)
- 배선 연결 확인
- 샘플링 횟수 증가 (10 → 20)

### 문제: 값이 음수로 나옴
**해결책:**
- calibration_factor 부호 변경
- A+와 A- 배선 교체

### 문제: 무게 증가시 값이 감소
**해결책:**
- calibration_factor를 양수로 변경
- 또는 A+와 A- 배선 교체

### 문제: 영점이 계속 변함
**해결책:**
- 온도 안정화 대기 (전원 인가 후 5분)
- 주기적 영점 조정 코드 추가
- 로드셀 품질 확인

## 📊 캘리브레이션 로그 예시

```
========================================
    로드셀 캘리브레이션 프로그램
========================================

영점 조정 완료!
Raw 값 (비었을 때): 8430

기준 무게 1000g 올림
Raw 값 (1000g): -2148231

계산된 Calibration Factor: -2156.661

미세 조정 후 최종값: -2156.7
========================================

테스트 결과:
- 0g: 0.2g (오차 0.2g)
- 500g: 499.8g (오차 -0.04%)
- 1000g: 1000.1g (오차 0.01%)
- 2000g: 2003.5g (오차 0.175%)
```

## 💡 팁

1. **온도 보상**
   - 로드셀은 온도에 민감함
   - 사용 환경과 비슷한 온도에서 캘리브레이션

2. **정기적 재캘리브레이션**
   - 월 1회 권장
   - 측정값이 이상할 때 즉시 실행

3. **여러 포인트 캘리브레이션**
   - 0g, 500g, 1000g, 2000g에서 확인
   - 선형성이 좋지 않으면 로드셀 교체 고려

4. **캘리브레이션 값 백업**
   - 각 로드셀의 calibration_factor 기록
   - 로드셀 ID와 함께 보관